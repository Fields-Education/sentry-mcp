name: Sync Upstream

on:
  schedule:
    - cron: "0 6 * * *" # Every day at 6am UTC (1am EST)
  workflow_dispatch: # Allow manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          persist-credentials: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/getsentry/sentry-mcp.git || true
          git fetch upstream main

      - name: Check for upstream changes
        id: check
        run: |
          UPSTREAM_COMMITS=$(git rev-list HEAD..upstream/main --count)
          echo "upstream_commits=$UPSTREAM_COMMITS" >> $GITHUB_OUTPUT
          if [ "$UPSTREAM_COMMITS" -gt 0 ]; then
            echo "Found $UPSTREAM_COMMITS new commits from upstream"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "No new commits from upstream"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Try to merge upstream
        id: merge
        if: steps.check.outputs.has_changes == 'true'
        continue-on-error: true
        run: |
          # Create a sync branch
          BRANCH_NAME="sync-upstream-$(date +%Y%m%d)"
          git checkout -b "$BRANCH_NAME"
          
          # Try to merge upstream
          if git merge upstream/main --no-edit; then
            echo "merge_success=true" >> $GITHUB_OUTPUT
            echo "Merge successful!"
            
            # Ensure disabled workflows stay disabled
            if [ -f ".github/workflows/deploy.yml" ]; then
              mv .github/workflows/deploy.yml .github/workflows/deploy.yml.disabled
              git add .github/workflows/deploy.yml.disabled
              git rm .github/workflows/deploy.yml 2>/dev/null || true
            fi
            if [ -f ".github/workflows/release.yml" ]; then
              mv .github/workflows/release.yml .github/workflows/release.yml.disabled
              git add .github/workflows/release.yml.disabled
              git rm .github/workflows/release.yml 2>/dev/null || true
            fi
            
            # Check if we need to commit the disabled workflow changes
            if ! git diff --cached --quiet; then
              git commit --amend --no-edit
            fi
            
            # Push the branch
            git push -u origin HEAD
            
            # Create PR using gh cli
            gh pr create \
              --title "chore: sync with upstream sentry-mcp" \
              --body "$(cat <<'EOF'
          ## Automated Upstream Sync

          This PR merges the latest changes from [getsentry/sentry-mcp](https://github.com/getsentry/sentry-mcp).

          ### Changes from upstream
          $(git log HEAD...origin/main --oneline --no-merges | head -20)

          ### Fork-specific notes
          - Sentry deployment workflows remain disabled (`.disabled` suffix)
          - Fields deployment workflow (`deploy-fields.yml`) unchanged
          - Fields Cloudflare package (`mcp-cloudflare-fields/`) unchanged

          ---
          *This PR was automatically created by the sync-upstream workflow.*
          EOF
          )" \
              --base main
          else
            echo "merge_success=false" >> $GITHUB_OUTPUT
            echo "Merge failed - conflicts detected"
            git merge --abort || true
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Use OpenCode to resolve conflicts
        if: steps.check.outputs.has_changes == 'true' && steps.merge.outputs.merge_success == 'false'
        uses: anomalyco/opencode/github@latest
        env:
          OPENCODE_API_KEY: ${{ secrets.OPENCODE_API_KEY }}
        with:
          model: opencode/claude-opus-4-5
          prompt: |
            There are merge conflicts when trying to sync this fork with upstream getsentry/sentry-mcp.

            Please help resolve the merge conflicts:

            1. First, run these commands to set up the merge:
               ```bash
               git remote add upstream https://github.com/getsentry/sentry-mcp.git || true
               git fetch upstream main
               git checkout -b sync-upstream-$(date +%Y%m%d)-resolved
               git merge upstream/main || true
               ```

            2. Review the conflicts. Key context for this fork:
               - This is the Fields Education fork deployed to Cloudflare
               - `packages/mcp-cloudflare-fields/` is OUR package (symlinks to mcp-cloudflare source)
               - `.github/workflows/deploy-fields.yml` is OUR workflow - DO NOT modify
               - `.github/workflows/sync-upstream.yml` is OUR workflow - DO NOT modify

            3. IMPORTANT - Keep these Sentry workflows DISABLED:
               - If `deploy.yml` appears, rename it to `deploy.yml.disabled`
               - If `release.yml` appears, rename it to `release.yml.disabled`
               - Our `.disabled` suffix prevents them from running

            4. Resolve conflicts by:
               - Accepting upstream changes for source code in `packages/mcp-cloudflare/src/`
               - Accepting upstream changes for `packages/mcp-core/`
               - Preserving our `.disabled` workflow files (rename any restored ones)
               - Keeping our `packages/mcp-cloudflare-fields/` configs unchanged
               - For `pnpm-lock.yaml`, delete it and run `pnpm install` to regenerate

            5. If `index.html` in `packages/mcp-cloudflare/` changed:
               - Copy the updated version to `packages/mcp-cloudflare-fields/index.html`
               - (It can't be symlinked due to Vite build path resolution issues)

            6. After resolving all conflicts:
               - Stage all changes: `git add -A`
               - Commit: `git commit -m "chore: sync with upstream sentry-mcp (resolved conflicts)"`
               - Push: `git push -u origin HEAD`
               - Create a PR to main branch
