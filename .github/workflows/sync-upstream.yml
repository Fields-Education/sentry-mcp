name: Sync Upstream

# NOTE: GitHub disables scheduled workflows on forks by default.
# Use repository_dispatch from an external cron (e.g., Cloudflare Worker) to trigger.

on:
  schedule:
    - cron: "0 6 * * *" # Every day at 6am UTC (1am EST) - NOTE: Won't fire on forks
  repository_dispatch:
    types: [sync-upstream]
  workflow_dispatch: # Allow manual trigger

jobs:
  sync:
    runs-on: blacksmith-4vcpu-ubuntu-2404
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          persist-credentials: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/getsentry/sentry-mcp.git || true
          git fetch upstream main

      - name: Check for upstream changes
        id: check
        run: |
          UPSTREAM_COMMITS=$(git rev-list HEAD..upstream/main --count)
          echo "upstream_commits=$UPSTREAM_COMMITS" >> $GITHUB_OUTPUT
          if [ "$UPSTREAM_COMMITS" -gt 0 ]; then
            echo "Found $UPSTREAM_COMMITS new commits from upstream"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "No new commits from upstream"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Try to merge upstream
        id: merge
        if: steps.check.outputs.has_changes == 'true'
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          # Create a sync branch
          BRANCH_NAME="sync-upstream-$(date +%Y%m%d)"
          
          # Delete the remote branch if it exists (from a previous failed/partial run)
          git push origin --delete "$BRANCH_NAME" 2>/dev/null || true
          
          git checkout -b "$BRANCH_NAME"
          
          # Try to merge upstream
          if git merge upstream/main --no-edit; then
            echo "merge_success=true" >> $GITHUB_OUTPUT
            echo "Merge successful!"
            
            # Ensure disabled workflows stay disabled
            WORKFLOWS_CHANGED=false
            if [ -f ".github/workflows/deploy.yml" ]; then
              mv .github/workflows/deploy.yml .github/workflows/deploy.yml.disabled
              git add .github/workflows/deploy.yml.disabled
              git rm .github/workflows/deploy.yml 2>/dev/null || true
              WORKFLOWS_CHANGED=true
            fi
            if [ -f ".github/workflows/release.yml" ]; then
              mv .github/workflows/release.yml .github/workflows/release.yml.disabled
              git add .github/workflows/release.yml.disabled
              git rm .github/workflows/release.yml 2>/dev/null || true
              WORKFLOWS_CHANGED=true
            fi
            
            # Commit the disabled workflow changes if any
            if [ "$WORKFLOWS_CHANGED" = true ]; then
              git commit -m "chore: keep sentry workflows disabled"
            fi
            
            # Push directly to main (clean merge, no PR needed)
            git checkout main
            git merge "$BRANCH_NAME" --no-edit
            git push origin main
            
            # Clean up the sync branch
            git push origin --delete "$BRANCH_NAME" 2>/dev/null || true
            
            echo "Successfully synced upstream changes directly to main"
          else
            echo "merge_success=false" >> $GITHUB_OUTPUT
            echo "Merge failed - conflicts detected"
            git merge --abort || true
          fi

      - name: Use OpenCode to resolve conflicts
        if: steps.check.outputs.has_changes == 'true' && steps.merge.outputs.merge_success == 'false'
        uses: anomalyco/opencode/github@latest
        env:
          OPENCODE_API_KEY: ${{ secrets.OPENCODE_API_KEY }}
        with:
          model: opencode/claude-opus-4-5
          prompt: |
            There are merge conflicts when trying to sync this fork with upstream getsentry/sentry-mcp.

            Please help resolve the merge conflicts:

            1. First, run these commands to set up the merge:
               ```bash
               git remote add upstream https://github.com/getsentry/sentry-mcp.git || true
               git fetch upstream main
               BRANCH_NAME="sync-upstream-$(date +%Y%m%d)-resolved"
               # Delete remote branch if it exists from a previous run
               git push origin --delete "$BRANCH_NAME" 2>/dev/null || true
               git checkout -b "$BRANCH_NAME"
               git merge upstream/main || true
               ```

            2. Review the conflicts. Key context for this fork:
               - This is the Fields Education fork deployed to Cloudflare
               - `packages/mcp-cloudflare-fields/` is OUR package (symlinks to mcp-cloudflare source)
               - `.github/workflows/deploy-fields.yml` is OUR workflow - DO NOT modify
               - `.github/workflows/sync-upstream.yml` is OUR workflow - DO NOT modify

            3. IMPORTANT - Keep these Sentry workflows DISABLED:
               - If `deploy.yml` appears, rename it to `deploy.yml.disabled`
               - If `release.yml` appears, rename it to `release.yml.disabled`
               - Our `.disabled` suffix prevents them from running

            4. Resolve conflicts by:
               - Accepting upstream changes for source code in `packages/mcp-cloudflare/src/`
               - Accepting upstream changes for `packages/mcp-core/`
               - Preserving our `.disabled` workflow files (rename any restored ones)
               - Keeping our `packages/mcp-cloudflare-fields/` configs unchanged
               - For `pnpm-lock.yaml`, delete it and run `pnpm install` to regenerate

            5. If `index.html` in `packages/mcp-cloudflare/` changed:
               - Copy the updated version to `packages/mcp-cloudflare-fields/index.html`
               - (It can't be symlinked due to Vite build path resolution issues)

            6. After resolving all conflicts:
               - Stage all changes: `git add -A`
               - Commit: `git commit -m "chore: sync with upstream sentry-mcp (resolved conflicts)"`
               - Push: `git push -u origin HEAD`
               - Create a PR to main branch
